name: Build Debian Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build-and-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Debian packaging tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      - name: Build .deb packages
        run: |
          mkdir -p ./debs
          for dir in ./sources/*; do
            dpkg-deb --root-owner-group --build "$dir" "./debs/$(basename "$dir").deb"
          done

      - name: Generate APT index
        run: |
          cd debs
          dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz

      - name: remove sources
        run: |
          rm -r ./sources
          
      - name: commit and push
        run: |
          git config --global user.email "kainatquaderee@users.noreply.github.com"
          git config --global user.name "kainatquaderee"
          git add .
          git commit --message 'auto-commited-by-action'
          git push origin HEAD:ppa --force
